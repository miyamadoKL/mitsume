# サブスクリプション

サブスクリプションは、ダッシュボードを定期的にキャプチャし、指定したチャンネルに自動配信する機能です。
定期レポートの自動送信に活用できます。

## 画面構成

```
┌─────────────────────────────────────────────────────────────┐
│  Subscriptions                      [+ Create Subscription] │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐  ┌─────────────────────┐          │
│  │ 🔔 週次売上レポート   │  │ 🔕 月次KPIレポート   │          │
│  │ ダッシュボード: 売上  │  │ ダッシュボード: KPI  │          │
│  │ 🕐 毎週月曜 9:00     │  │ 🕐 毎月1日 9:00     │          │
│  │ 形式: PDF           │  │ 形式: PNG           │          │
│  │ 次回: 2024/01/22    │  │ 次回: 2024/02/01    │          │
│  │ [▶] [✏️] [🗑️]       │  │ [▶] [✏️] [🗑️]       │          │
│  └─────────────────────┘  └─────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 基本的な使い方

### サブスクリプションの作成

1. サイドバーから **Subscriptions** をクリックします
2. **Create Subscription** ボタンをクリックします
3. 設定ダイアログで以下を入力します

#### 基本設定

| 項目 | 説明 | 必須 |
|------|------|------|
| **Subscription Name** | サブスクリプションの識別名 | ✓ |
| **Dashboard** | 配信するダッシュボード | ✓ |

#### スケジュール設定

| 項目 | 説明 | 必須 |
|------|------|------|
| **Schedule** | 配信スケジュール（プリセット選択） | ✓ |
| **Timezone** | 実行時刻のタイムゾーン | ✓ |

#### 出力設定

| 項目 | 説明 | 必須 |
|------|------|------|
| **Export Format** | 出力形式（PDF / PNG） | ✓ |

#### 通知設定

| 項目 | 説明 | 必須 |
|------|------|------|
| **Notification Channels** | 配信先のチャンネル | |

4. **Create** をクリックしてサブスクリプションを作成します

### スケジュールプリセット

よく使うスケジュールがプリセットとして用意されています。

| プリセット | Cron式 | 説明 |
|-----------|--------|------|
| **Every hour** | `0 * * * *` | 毎時0分 |
| **Every day at 9 AM** | `0 9 * * *` | 毎日9:00 |
| **Every Monday at 9 AM** | `0 9 * * 1` | 毎週月曜9:00 |
| **Every 1st of month at 9 AM** | `0 9 1 * *` | 毎月1日9:00 |

### タイムゾーン

スケジュールの実行時刻は指定したタイムゾーンで解釈されます。

| タイムゾーン | 説明 |
|-------------|------|
| **Asia/Tokyo** | 日本標準時 (JST) |
| **UTC** | 協定世界時 |
| **America/New_York** | 米国東部時間 |
| **America/Los_Angeles** | 米国太平洋時間 |
| **Europe/London** | 英国時間 |
| **Europe/Paris** | 中央ヨーロッパ時間 |

### 出力形式

| 形式 | 説明 | 用途 |
|------|------|------|
| **PDF** | PDF ドキュメント | 印刷、アーカイブ |
| **PNG** | 画像ファイル | チャットツール、プレゼン資料 |

### サブスクリプションの有効化/無効化

サブスクリプションは有効/無効を切り替えられます。

1. カードのベルアイコンをクリックします
   - 🔔（緑）: 有効 → クリックで無効化
   - 🔕（グレー）: 無効 → クリックで有効化
2. 無効化されたサブスクリプションは配信が停止されます

### 手動トリガー

スケジュールを待たずに手動で配信をトリガーできます。

1. カードの **▶** ボタンをクリックします
2. ダッシュボードがキャプチャされ、通知チャンネルに送信されます
3. 成功すると「Report sent」メッセージが表示されます

### サブスクリプションの編集

1. カードの **✏️** ボタンをクリックします
2. 編集ダイアログが開きます
3. 設定を変更して **Update** をクリックします

> **注意**: 配信対象のダッシュボードは変更できません。ダッシュボードを変更する場合は、新しいサブスクリプションを作成してください。

### サブスクリプションの削除

1. カードの **🗑️** ボタンをクリックします
2. 確認ダイアログで **Delete** をクリックします

## カード表示情報

各サブスクリプションカードには以下が表示されます:

| 項目 | 説明 |
|------|------|
| **名前** | サブスクリプション名 |
| **ダッシュボード** | 配信対象のダッシュボード名 |
| **スケジュール** | 配信スケジュール（読みやすい形式） |
| **形式** | 出力形式（PDF / PNG） |
| **次回実行** | 次回の配信予定日時 |
| **最終配信** | 最後に配信された日時 |

## 配信の仕組み

### 配信フロー

```
┌─────────────────┐
│ スケジュール時刻 │
│ に到達          │
└────────┬────────┘
         ↓
┌────────┴────────┐
│ ダッシュボード   │
│ のキャプチャ     │
└────────┬────────┘
         ↓
┌────────┴────────┐
│ PDF/PNG への     │
│ 変換             │
└────────┬────────┘
         ↓
┌────────┴────────┐
│ 通知チャンネル   │
│ への送信         │
└────────┬────────┘
         ↓
┌────────┴────────┐
│ 次回実行時刻の   │
│ 計算             │
└─────────────────┘
```

### キャプチャ内容

配信されるレポートには、配信時点のダッシュボード全体が含まれます。

- すべてのウィジェットが最新データで表示されます
- パラメータはデフォルト値が使用されます

## 設計例

### 例1: 日次売上レポート

**目的**: 毎日の売上サマリーを営業チームに配信

**設定**:
- Subscription Name: `日次売上レポート`
- Dashboard: `売上ダッシュボード`
- Schedule: `Every day at 9 AM`
- Timezone: `Asia/Tokyo`
- Export Format: `PDF`
- Notification Channels: `#sales-team` (Slack)

### 例2: 週次KPIレポート

**目的**: 週次のKPIを経営陣に配信

**設定**:
- Subscription Name: `週次KPIレポート`
- Dashboard: `経営KPIダッシュボード`
- Schedule: `Every Monday at 9 AM`
- Timezone: `Asia/Tokyo`
- Export Format: `PDF`
- Notification Channels: `management@example.com` (Email)

### 例3: 月次在庫レポート

**目的**: 月次の在庫状況を在庫管理チームに配信

**設定**:
- Subscription Name: `月次在庫レポート`
- Dashboard: `在庫状況ダッシュボード`
- Schedule: `Every 1st of month at 9 AM`
- Timezone: `Asia/Tokyo`
- Export Format: `PNG`
- Notification Channels: `#inventory-team` (Slack)

## 状態表示

### ローディング状態

データ読み込み中はスケルトンローダーが表示されます。

### エラー状態

読み込みに失敗した場合:
- エラーメッセージが表示されます
- **Retry** ボタンで再読み込みできます

### 空の状態

サブスクリプションがない場合:
- 「No subscriptions」メッセージが表示されます
- **Create Subscription** ボタンでサブスクリプションを作成できます

## 注意事項

1. **通知チャンネルの設定**: サブスクリプションを作成する前に、通知チャンネルを設定しておく必要があります
2. **ダッシュボードのサイズ**: 大きなダッシュボードはキャプチャに時間がかかる場合があります
3. **タイムゾーンの設定**: 意図した時刻に配信されるよう、正しいタイムゾーンを選択してください

## 関連ドキュメント

- [ダッシュボード](./dashboards.md) - 配信するダッシュボードの作成
- [通知チャンネル](./notification-channels.md) - 配信先の設定
