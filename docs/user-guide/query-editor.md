# クエリエディタ

クエリエディタは、SQL クエリを作成・実行し、結果を確認するための機能です。

## 画面構成

```
┌─────────────────────────────────────────────────────────────┐
│  カタログ選択  │  スキーマ選択  │  Execute  │  Save  │  Export │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  SQL エディタ                                                │
│  （Monaco Editor）                                          │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  クエリ結果テーブル                                          │
│                                                             │
│  ステータス: 実行時間、取得行数                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 基本的な使い方

### 1. カタログとスキーマの選択

1. 画面上部のドロップダウンからカタログを選択します
2. 続いてスキーマを選択します
3. 選択したカタログ・スキーマがクエリのデフォルトコンテキストになります

### 2. クエリの入力

SQL エディタに Trino SQL クエリを入力します。

```sql
SELECT
    customer_id,
    COUNT(*) as order_count,
    SUM(total_amount) as total_spent
FROM orders
WHERE order_date >= DATE '2024-01-01'
GROUP BY customer_id
ORDER BY total_spent DESC
LIMIT 100
```

#### エディタの機能

- **シンタックスハイライト**: SQL キーワード、文字列、数値などが色分け表示されます
- **オートコンプリート**: `Ctrl+Space` で入力補完候補が表示されます
- **行番号表示**: 左側に行番号が表示されます
- **エラー表示**: 構文エラーがある場合、赤い波線で表示されます

#### キーボードショートカット

| ショートカット | 動作 |
|---------------|------|
| `Ctrl+Enter` / `Cmd+Enter` | クエリを実行 |
| `Ctrl+S` / `Cmd+S` | クエリを保存 |
| `Ctrl+Space` | オートコンプリート |
| `Ctrl+/` / `Cmd+/` | 行コメントのトグル |
| `Ctrl+F` / `Cmd+F` | 検索 |
| `Ctrl+H` / `Cmd+H` | 置換 |

### 3. クエリの実行

1. **Execute** ボタンをクリック、または `Ctrl+Enter` を押します
2. クエリが Trino に送信され、実行されます
3. 実行中はローディング表示が出ます
4. 完了すると結果がテーブル形式で表示されます

#### 実行結果の表示

- **成功時**: 結果テーブルと実行統計（実行時間、取得行数）が表示されます
- **エラー時**: エラーメッセージが赤色で表示されます

### 4. 結果の確認

クエリ結果はテーブル形式で表示されます。

- **列ヘッダー**: クリックでソート（昇順/降順）
- **セル**: テキストが長い場合はツールチップで全文表示
- **ページネーション**: 大量のデータは複数ページに分割されます

### 5. 結果のエクスポート

クエリ結果をファイルとしてダウンロードできます。

1. **Export** ボタンをクリックします
2. 形式を選択します:
   - **CSV**: カンマ区切り形式
   - **TSV**: タブ区切り形式
3. ファイルがダウンロードされます

## クエリの保存

よく使うクエリは保存して再利用できます。

1. クエリを入力した状態で **Save** ボタンをクリックします
2. ダイアログが表示されます:
   - **名前**: クエリの識別名（必須）
   - **説明**: クエリの用途や内容の説明（任意）
3. **Save** をクリックして保存します

保存したクエリは「Saved Queries」ページで管理できます。

## エラー対処

### よくあるエラー

| エラーメッセージ | 原因 | 対処法 |
|-----------------|------|--------|
| `Table 'xxx' does not exist` | テーブルが存在しない | カタログ・スキーマを確認 |
| `Column 'xxx' cannot be resolved` | 列名が間違っている | 正しい列名を確認 |
| `Query exceeded maximum time limit` | クエリがタイムアウト | クエリを最適化するか、LIMIT を追加 |
| `Access Denied` | 権限がない | 管理者に権限を確認 |

### ネットワークエラー

接続エラーが発生した場合:

1. 「Retry」ボタンをクリックして再試行します
2. 繰り返しエラーが発生する場合は、管理者に連絡してください

## ベストプラクティス

### パフォーマンス向上のコツ

1. **LIMIT を使用する**: 結果件数を制限してレスポンスを高速化
   ```sql
   SELECT * FROM large_table LIMIT 1000
   ```

2. **必要な列のみ選択**: `SELECT *` を避け、必要な列を明示
   ```sql
   SELECT id, name, created_at FROM users  -- 推奨
   SELECT * FROM users                      -- 非推奨
   ```

3. **WHERE 句でフィルタリング**: 早い段階でデータを絞り込み
   ```sql
   SELECT * FROM events WHERE event_date >= DATE '2024-01-01'
   ```

4. **パーティション列を活用**: パーティションキーで絞り込み
   ```sql
   SELECT * FROM logs WHERE dt = '2024-01-15'
   ```

### SQL の書き方

1. **キーワードは大文字**: 可読性向上のため
   ```sql
   SELECT id, name FROM users WHERE status = 'active'
   ```

2. **エイリアスを使用**: 複雑なクエリでは列・テーブルにエイリアスを付与
   ```sql
   SELECT
       u.id,
       u.name,
       COUNT(o.id) AS order_count
   FROM users u
   LEFT JOIN orders o ON u.id = o.user_id
   GROUP BY u.id, u.name
   ```

## 関連ドキュメント

- [保存クエリ](./saved-queries.md) - クエリの保存と管理
- [ダッシュボード](./dashboards.md) - クエリ結果の可視化
